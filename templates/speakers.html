<!DOCTYPE html>
<html>
<head>
    <title>Speaker Management - WhisperX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            display: inline-block;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .debug-panel {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Hidden by default, set to block to show */
        }
        
        .speaker-item {
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: transform 0.2s;
            border-left: 4px solid #667eea;
        }
        
        .speaker-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .speaker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .speaker-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .speaker-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.3s;
        }
        
        .speaker-name:hover {
            color: #667eea;
            text-decoration-color: #667eea;
        }
        
        .speaker-stats {
            color: #666;
            font-size: 14px;
        }
        
        .speaker-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .audio-section {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .audio-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 100px;
        }
        
        .play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        .play-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        
        .play-btn.playing {
            background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
        }
        
        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .audio-status {
            font-size: 12px;
            color: #999;
            text-align: center;
        }
        
        .transcript-preview {
            flex: 1;
            padding: 15px;
            background: #f0f2ff;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .transcript-label {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .transcript-text {
            color: #333;
            line-height: 1.6;
            font-size: 15px;
            font-style: italic;
        }
        
        .no-transcript {
            color: #999;
            font-style: italic;
        }
        
        /* All clips section - initially hidden */
        .all-clips-section {
            margin-top: 15px;
            padding: 20px;
            background: #f0f2ff;
            border-radius: 8px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .all-clips-section.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .clips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .clip-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .clip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .clip-timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
        }
        
        .clip-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .clip-play-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }
        
        .clip-play-btn.playing {
            background: #ff5252;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-rename {
            background: #667eea;
            color: white;
        }
        
        .btn-rename:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-merge {
            background: #ffa726;
            color: white;
        }
        
        .btn-merge:hover {
            background: #fb9800;
        }
        
        .merge-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f0f2ff 0%, #e8ebff 100%);
            border-radius: 10px;
            border: 1px solid #d4d9ff;
        }
        
        .merge-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .identify-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 10px;
            border: 1px solid #a5d6a7;
        }
        
        .quick-identify {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            flex: 1;
            background: white;
            min-width: 200px;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="text"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .empty-state p {
            margin: 10px 0;
        }
        
        audio {
            display: none;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .unknown-speaker-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .unknown-speaker-name {
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
            margin-bottom: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 500;
            color: #333;
        }
        
        .error-message {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success-message {
            color: #155724;
            padding: 10px;
            background: #d4edda;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👥 Speaker Management</h1>
            <p>Listen to speakers and identify them across your transcriptions</p>
        </div>
        
        <div class="nav-links">
            <a href="/">🎙️ Transcribe</a>
            <a href="/speakers">👥 Speakers</a>
            <a href="/search">🔍 Search</a>
            <a href="/admin">🛠️ Admin</a>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 10px;">Detected Speakers</h2>
            <p style="color: #666; margin-bottom: 25px;">Click on a speaker's name to see all their clips, or listen to their sample</p>
            
            <!-- Debug panel (hidden by default) -->
            <div class="debug-panel" id="debugPanel">
                <strong>Debug Info:</strong><br>
                <div id="debugContent">Loading debug info...</div>
            </div>
            
            <div id="speakersList">
                <div class="empty-state">Loading speakers...</div>
            </div>
            
            <div class="identify-section">
                <h3>🎯 Identify Unknown Speakers</h3>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">
                    Listen to unknown speakers and identify them as people you know
                </p>
                
                <div id="unknownSpeakers" style="margin-top: 20px;">
                    <!-- Will be populated with unnamed SPEAKER_XX entries -->
                </div>
                
                <div class="quick-identify">
                    <h4 style="margin-bottom: 10px;">Quick Identify</h4>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="unknownSpeakerSelect" style="flex: 1;">
                            <option value="">Select unknown speaker...</option>
                        </select>
                        <span>is actually</span>
                        <input type="text" 
                               id="knownNameInput" 
                               placeholder="Enter their real name..." 
                               style="flex: 1;">
                        <button class="btn" 
                                style="background: #4CAF50; color: white; padding: 10px 20px;"
                                onclick="identifySpeaker()">
                            ✓ Identify
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="merge-section">
                <h3>🔄 Merge Duplicate Speakers</h3>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">
                    After identifying speakers by their voice and words, merge duplicates here
                </p>
                <div class="merge-controls">
                    <select id="fromSpeaker">
                        <option value="">Select speaker to merge from...</option>
                    </select>
                    <span style="font-size: 20px;">→</span>
                    <select id="toSpeaker">
                        <option value="">Merge into this speaker...</option>
                    </select>
                    <button class="btn btn-merge" onclick="mergeSpeakers()">Merge Speakers</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden audio element for playback -->
    <audio id="audioPlayer"></audio>
    
    <script>
        let speakers = [];
        let currentlyPlaying = null;
        let currentlyPlayingClip = null;
        let availableClips = {};
        let speakerTexts = {};
        let debugInfo = [];
        let debugMode = false; // Set to true to show debug panel
        
        function addDebug(message) {
            if (!debugMode) return;
            
            debugInfo.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            if (debugInfo.length > 100) debugInfo.shift(); // Keep last 100 messages
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugInfo.join('<br>');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            console.log(message);
        }
        
        // Initialize debug panel visibility
        if (debugMode) {
            document.getElementById('debugPanel').style.display = 'block';
        }
        
        // Load everything
        loadData();
        
        async function loadData() {
            addDebug('Starting loadData...');
            try {
                await loadClips();
                await loadSpeakerTexts();
                await loadSpeakers();
                loadUnknownSpeakers();
                addDebug('Finished loadData');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('❌ Error loading speaker data', 'error');
            }
        }
        
        async function loadClips() {
            addDebug('Loading clips...');
            try {
                const response = await fetch('/api/all_speaker_clips');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const clips = await response.json();
                addDebug(`Loaded ${clips.length} clips`);
                
                // Organize clips by speaker
                availableClips = {};
                clips.forEach(clip => {
                    if (!availableClips[clip.speaker]) {
                        availableClips[clip.speaker] = [];
                    }
                    availableClips[clip.speaker].push(clip);
                });
                
                addDebug(`Organized clips for speakers: ${Object.keys(availableClips).join(', ')}`);
            } catch (err) {
                addDebug(`ERROR loading clips: ${err}`);
                console.error('Failed to load clips:', err);
            }
        }
        
        async function loadSpeakerTexts() {
            addDebug('Loading speaker texts...');
            try {
                const response = await fetch('/api/speaker_texts');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                speakerTexts = await response.json();
                addDebug(`Loaded texts for: ${Object.keys(speakerTexts).join(', ')}`);
            } catch (err) {
                addDebug(`ERROR loading texts: ${err}`);
                console.error('Failed to load speaker texts:', err);
            }
        }
        
        async function loadSpeakers() {
            addDebug('Loading speakers...');
            try {
                const response = await fetch('/api/speakers');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                speakers = await response.json();
                addDebug(`Loaded ${speakers.length} speakers`);
                
                const container = document.getElementById('speakersList');
                const fromSelect = document.getElementById('fromSpeaker');
                const toSelect = document.getElementById('toSpeaker');
                
                // Clear selects
                fromSelect.innerHTML = '<option value="">Select speaker to merge from...</option>';
                toSelect.innerHTML = '<option value="">Merge into this speaker...</option>';
                
                if (speakers.length === 0) {
                    addDebug('No speakers found');
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>🔭 No Speakers Detected Yet</h3>
                            <p>Process audio files with speaker diarization enabled to identify speakers.</p>
                            <p>Once processed, you'll be able to listen to each speaker and identify them.</p>
                        </div>
                    `;
                } else {
                    addDebug('Rendering speaker list...');
                    container.innerHTML = speakers.map((speaker, index) => {
                        // Check for clips using speaker.id
                        const speakerClips = availableClips[speaker.id] || [];
                        const hasClip = speakerClips.length > 0 || speaker.has_clip;
                        
                        // Get text using speaker.id
                        const speakerText = speakerTexts[speaker.id] || {};
                        const textPreview = speaker.sample_text || speakerText.text || 'No transcript available';
                        
                        return `
                        <div class="speaker-item">
                            <div class="speaker-header">
                                <div class="speaker-info">
                                    <span class="speaker-name" 
                                          onclick="toggleAllClips('${speaker.id}', ${index})" 
                                          id="speaker-${index}"
                                          title="Click to see all clips">
                                        ${speaker.name} ${speakerClips.length > 1 ? `(${speakerClips.length} clips)` : ''}
                                    </span>
                                    <span class="speaker-stats">
                                        📊 ${speaker.appearance_count} ${speaker.appearance_count === 1 ? 'appearance' : 'appearances'}
                                    </span>
                                </div>
                                <div class="speaker-actions">
                                    <button class="btn btn-rename" onclick="renameSpeaker('${speaker.id}', ${index})">
                                        ✏️ Rename
                                    </button>
                                </div>
                            </div>
                            
                            <div class="audio-section">
                                <div class="audio-controls">
                                    <button class="play-btn" id="play-${index}" 
                                            onclick="togglePlay('${speaker.id}', ${index})"
                                            ${!hasClip ? 'disabled' : ''}
                                            title="${hasClip ? 'Play sample' : 'No audio available'}">
                                        <span id="play-icon-${index}">▶</span>
                                    </button>
                                    <span class="audio-status" id="status-${index}">
                                        ${hasClip ? 'Play sample' : 'No audio'}
                                    </span>
                                </div>
                                
                                <div class="transcript-preview">
                                    <div class="transcript-label">Sample transcript</div>
                                    <div class="transcript-text" id="text-${index}">
                                        ${textPreview !== 'No transcript available' ? 
                                            '"' + textPreview + '"' : 
                                            '<span class="no-transcript">' + textPreview + '</span>'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- All clips section - hidden by default -->
                            <div class="all-clips-section" id="clips-section-${index}">
                                <h4 style="margin-bottom: 10px;">📚 All Clips for ${speaker.name}</h4>
                                ${speakerClips.length > 0 ? `
                                    <div class="clips-grid" id="clips-grid-${index}">
                                        ${speakerClips.map((clip, clipIndex) => `
                                            <div class="clip-card">
                                                <button class="clip-play-btn" id="clip-${index}-${clipIndex}"
                                                        onclick="playClip('${clip.filename}', ${index}, ${clipIndex})"
                                                        title="Play clip ${clipIndex + 1}">
                                                    <span id="clip-icon-${index}-${clipIndex}">▶</span>
                                                </button>
                                                <div class="clip-timestamp">Clip ${clipIndex + 1}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="text-align: center; color: #999;">No additional clips available</p>'}
                            </div>
                        </div>
                    `}).join('');
                    
                    // Populate merge selects
                    speakers.forEach(speaker => {
                        const option1 = `<option value="${speaker.id}">${speaker.name}</option>`;
                        const option2 = `<option value="${speaker.id}">${speaker.name}</option>`;
                        fromSelect.innerHTML += option1;
                        toSelect.innerHTML += option2;
                    });
                    
                    addDebug('Finished rendering speakers');
                }
            } catch (err) {
                addDebug(`ERROR loading speakers: ${err}`);
                console.error('Failed to load speakers:', err);
                document.getElementById('speakersList').innerHTML = 
                    '<div class="error-message">❌ Error loading speakers. Please refresh the page.</div>';
            }
        }
        
        function toggleAllClips(speakerId, index) {
            const clipsSection = document.getElementById(`clips-section-${index}`);
            if (clipsSection) {
                // Toggle visibility
                if (clipsSection.classList.contains('show')) {
                    clipsSection.classList.remove('show');
                } else {
                    // Hide all other clip sections
                    document.querySelectorAll('.all-clips-section').forEach(section => {
                        section.classList.remove('show');
                    });
                    // Show this one
                    clipsSection.classList.add('show');
                }
            }
        }
        
        function playClip(filename, speakerIndex, clipIndex) {
            const audio = document.getElementById('audioPlayer');
            const playBtn = document.getElementById(`clip-${speakerIndex}-${clipIndex}`);
            const playIcon = document.getElementById(`clip-icon-${speakerIndex}-${clipIndex}`);
            
            // If this clip is already playing, stop it
            if (currentlyPlayingClip === `${speakerIndex}-${clipIndex}`) {
                audio.pause();
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                currentlyPlayingClip = null;
                return;
            }
            
            // Stop any other playing audio
            stopAllAudio();
            
            // Play this clip using the filename directly
            audio.src = `/api/speaker_clip/${filename}`;
            
            audio.play().then(() => {
                playIcon.textContent = '⏸';
                playBtn.classList.add('playing');
                currentlyPlayingClip = `${speakerIndex}-${clipIndex}`;
                addDebug(`Playing clip: ${filename}`);
            }).catch(err => {
                console.error('Failed to play clip:', err);
                showNotification('❌ Failed to play audio clip', 'error');
            });
            
            // Reset when audio ends
            audio.onended = () => {
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                currentlyPlayingClip = null;
            };
            
            // Handle audio errors
            audio.onerror = () => {
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                currentlyPlayingClip = null;
                showNotification('❌ Error loading audio clip', 'error');
            };
        }
        
        function loadUnknownSpeakers() {
            const unknownContainer = document.getElementById('unknownSpeakers');
            const unknownSelect = document.getElementById('unknownSpeakerSelect');
            
            // Filter for SPEAKER_XX format (unknown speakers)
            const unknownSpeakers = speakers.filter(s => /^SPEAKER_\d+$/.test(s.name));
            
            if (unknownSpeakers.length === 0) {
                unknownContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; color: #666;">
                        ✨ All speakers have been identified!
                    </div>
                `;
                unknownSelect.innerHTML = '<option value="">No unknown speakers</option>';
            } else {
                unknownContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        ${unknownSpeakers.map((speaker, idx) => {
                            const hasClip = (availableClips[speaker.id] && availableClips[speaker.id].length > 0) || speaker.has_clip;
                            return `
                                <div class="unknown-speaker-card">
                                    <div class="unknown-speaker-name">
                                        ${speaker.name}
                                    </div>
                                    <button class="play-btn" style="width: 48px; height: 48px; margin: 10px auto;"
                                            onclick="playQuickSample('${speaker.id}', ${speakers.indexOf(speaker)})"
                                            ${!hasClip ? 'disabled' : ''}
                                            title="${hasClip ? 'Play sample' : 'No audio available'}">
                                        <span>▶</span>
                                    </button>
                                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                        ${speaker.appearance_count} appearance${speaker.appearance_count !== 1 ? 's' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                // Populate select dropdown
                unknownSelect.innerHTML = '<option value="">Select unknown speaker...</option>' +
                    unknownSpeakers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
        }
        
        function togglePlay(speakerId, index) {
            addDebug(`Playing speaker ${speakerId}`);
            const audio = document.getElementById('audioPlayer');
            const playBtn = document.getElementById(`play-${index}`);
            const playIcon = document.getElementById(`play-icon-${index}`);
            const status = document.getElementById(`status-${index}`);
            
            // If this speaker is already playing, stop it
            if (currentlyPlaying === index) {
                audio.pause();
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                status.textContent = 'Play sample';
                currentlyPlaying = null;
                return;
            }
            
            // Stop any other playing audio
            stopAllAudio();
            
            // Play this speaker's audio - use the passed speakerId
            audio.src = `/api/speaker_clip/${speakerId}`;
            
            audio.play().then(() => {
                playIcon.textContent = '⏸';
                playBtn.classList.add('playing');
                status.textContent = 'Playing...';
                currentlyPlaying = index;
            }).catch(err => {
                addDebug(`ERROR playing audio: ${err}`);
                console.error('Failed to play audio:', err);
                status.textContent = 'Error';
                showNotification('❌ Failed to play audio', 'error');
            });
            
            // Reset when audio ends
            audio.onended = () => {
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                status.textContent = 'Play sample';
                currentlyPlaying = null;
            };
            
            // Handle audio errors
            audio.onerror = () => {
                playIcon.textContent = '▶';
                playBtn.classList.remove('playing');
                status.textContent = 'Error';
                currentlyPlaying = null;
                showNotification('❌ Error loading audio', 'error');
            };
        }
        
        function stopAllAudio() {
            const audio = document.getElementById('audioPlayer');
            audio.pause();
            
            // Stop main player
            if (currentlyPlaying !== null) {
                const prevIcon = document.getElementById(`play-icon-${currentlyPlaying}`);
                const prevBtn = document.getElementById(`play-${currentlyPlaying}`);
                const prevStatus = document.getElementById(`status-${currentlyPlaying}`);
                if (prevIcon) prevIcon.textContent = '▶';
                if (prevBtn) prevBtn.classList.remove('playing');
                if (prevStatus) prevStatus.textContent = 'Play sample';
                currentlyPlaying = null;
            }
            
            // Stop any clip player
            if (currentlyPlayingClip) {
                const [prevSpeaker, prevClip] = currentlyPlayingClip.split('-');
                const prevIcon = document.getElementById(`clip-icon-${prevSpeaker}-${prevClip}`);
                const prevBtn = document.getElementById(`clip-${prevSpeaker}-${prevClip}`);
                if (prevIcon) prevIcon.textContent = '▶';
                if (prevBtn) prevBtn.classList.remove('playing');
                currentlyPlayingClip = null;
            }
        }
        
        function playQuickSample(speakerId, index) {
            togglePlay(speakerId, index);
        }
        
        async function renameSpeaker(speakerId, index) {
            const currentName = speakers[index].name;
            const newName = prompt(`Rename speaker "${currentName}" to:`, currentName);
            
            if (newName && newName !== currentName) {
                try {
                    // Save to database via API
                    const response = await fetch(`/api/speakers/${speakerId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: newName })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Update UI
                        const nameElement = document.getElementById(`speaker-${index}`);
                        const clipsCount = (availableClips[speakerId] || []).length;
                        nameElement.textContent = newName + (clipsCount > 1 ? ` (${clipsCount} clips)` : '');
                        speakers[index].name = newName;
                        
                        // Show success feedback
                        nameElement.style.color = '#4CAF50';
                        showNotification(`✅ Speaker renamed to "${newName}"`, 'success');
                        
                        setTimeout(() => {
                            nameElement.style.color = '#333';
                        }, 1000);
                        
                        // Reload speakers to refresh the list
                        setTimeout(() => {
                            loadData();
                        }, 1500);
                    } else {
                        const error = await response.json();
                        showNotification(`❌ Failed to save: ${error.error || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    console.error('Error saving speaker name:', err);
                    showNotification('❌ Failed to save speaker name', 'error');
                }
            }
        }
        
        async function mergeSpeakers() {
            const from = document.getElementById('fromSpeaker').value;
            const to = document.getElementById('toSpeaker').value;
            
            if (!from || !to) {
                showNotification('⚠️ Please select both speakers to merge', 'error');
                return;
            }
            
            if (from === to) {
                showNotification('⚠️ Cannot merge a speaker with itself', 'error');
                return;
            }
            
            const fromSpeaker = speakers.find(s => s.id === from);
            const toSpeaker = speakers.find(s => s.id === to);
            
            if (confirm(`Merge "${fromSpeaker?.name || from}" into "${toSpeaker?.name || to}"?\n\nThis will combine all their appearances and segments.`)) {
                try {
                    showNotification('⏳ Merging speakers...', 'info');
                    
                    const response = await fetch('/api/speakers/merge', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ from, to })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`✅ Successfully merged speakers!`, 'success');
                        
                        // Clear selections
                        document.getElementById('fromSpeaker').value = '';
                        document.getElementById('toSpeaker').value = '';
                        
                        // Reload the page data
                        setTimeout(() => {
                            loadData();
                        }, 1000);
                    } else {
                        const error = await response.json();
                        showNotification(`❌ Merge failed: ${error.error || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    console.error('Error merging speakers:', err);
                    showNotification('❌ Failed to merge speakers', 'error');
                }
            }
        }
        
        async function identifySpeaker() {
            const unknownSpeaker = document.getElementById('unknownSpeakerSelect').value;
            const knownName = document.getElementById('knownNameInput').value.trim();
            
            if (!unknownSpeaker || !knownName) {
                showNotification('⚠️ Please select a speaker and enter a name', 'error');
                return;
            }
            
            try {
                // Check if we should merge with existing or just rename
                const existingSpeaker = speakers.find(s => s.name === knownName);
                
                if (existingSpeaker) {
                    // Merge with existing
                    if (confirm(`"${knownName}" already exists. Merge ${unknownSpeaker} into ${knownName}?`)) {
                        const response = await fetch('/api/speakers/merge', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ from: unknownSpeaker, to: existingSpeaker.id })
                        });
                        
                        if (response.ok) {
                            showNotification(`✅ Merged into ${knownName}`, 'success');
                        } else {
                            throw new Error('Merge failed');
                        }
                    }
                } else {
                    // Just rename
                    const response = await fetch(`/api/speakers/${unknownSpeaker}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: knownName })
                    });
                    
                    if (response.ok) {
                        showNotification(`✅ Identified as ${knownName}`, 'success');
                    } else {
                        throw new Error('Rename failed');
                    }
                }
                
                // Clear inputs and reload
                document.getElementById('unknownSpeakerSelect').value = '';
                document.getElementById('knownNameInput').value = '';
                
                setTimeout(() => {
                    loadData();
                }, 1000);
                
            } catch (err) {
                console.error('Error identifying speaker:', err);
                showNotification('❌ Failed to identify speaker', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Remove any existing notification
            const existing = document.getElementById('notification');
            if (existing) {
                existing.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = 'notification';
            
            // Add type-specific styling
            if (type === 'error') {
                notification.style.background = '#f8d7da';
                notification.style.color = '#721c24';
            } else if (type === 'success') {
                notification.style.background = '#d4edda';
                notification.style.color = '#155724';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds (longer for errors)
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Space bar to pause/play current audio
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                const audio = document.getElementById('audioPlayer');
                if (!audio.paused) {
                    audio.pause();
                }
            }
            
            // Escape to stop all audio
            if (e.code === 'Escape') {
                stopAllAudio();
            }
        });
        
        // Auto-refresh every 30 seconds if no audio is playing
        setInterval(() => {
            const audio = document.getElementById('audioPlayer');
            if (audio.paused) {
                loadData();
            }
        }, 30000);
    </script>
</body>
</html>
